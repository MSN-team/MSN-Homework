<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>实时录音 · PopQuiz Demo</title>
    <style>
        body  { font-family:sans-serif; padding:2rem; }
        button{ margin-right:1rem; padding:.6rem 1.4rem; font-size:1rem; }
        #log  { white-space:pre-wrap; border:1px solid #ccc; height:16rem;
            padding:1rem; margin-top:1rem; overflow-y:auto; font-size:.95rem; }
        .quiz{ margin:.8rem 0; padding:.6rem; border:1px dashed #999; }
        .quiz b{ display:block; margin-bottom:.4rem; }
    </style>
</head>
<body>
<button id="start">🎙️ 开始录音</button>
<button id="stop"  disabled>■ 停止录音</button>
<span id="timer"></span>
<div id="log"></div>

<script>
    (() => {
        const WS_URL   = "ws://127.0.0.1:8000/record-audio";
        const CHUNK_MS = 1000;          // 每 1 s 推送一次

        let recorder, ws, timerId, startAt, stopRequested = false;
        const $start = document.getElementById("start");
        const $stop  = document.getElementById("stop");
        const $log   = document.getElementById("log");
        const $timer = document.getElementById("timer");

        const log = msg => { $log.textContent += msg + "\n";
            $log.scrollTop = $log.scrollHeight; };

        // -------- 计时器 --------
        const tick = () => {
            const sec = Math.floor((Date.now() - startAt) / 1000);
            $timer.textContent = `⏱️ ${sec}s`;
        };

        // -------- 开始录音 --------
        $start.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
            } catch (err) {
                log("❌ 无法访问麦克风：" + err.message);
                return;
            }

            $start.disabled = true; $stop.disabled = false;
            stopRequested = false;

            ws = new WebSocket(WS_URL);
            ws.binaryType = "arraybuffer";

            ws.onopen = () => {
                log("✅ WebSocket 已连接");
                recorder.start(CHUNK_MS);
                startAt = Date.now();
                timerId = setInterval(tick, 1000);
                log("🎤 开始录音…");
            };

            ws.onmessage = e => {
                try {
                    const data = JSON.parse(e.data);
                    if (data.status === "success") {
                        log("📩 收到服务器结果：");
                        data.quizzes.forEach(q => showQuiz(q));
                    } else {
                        log("⚠️ 服务器返回错误：" + data.detail);
                    }
                } catch {
                    log("📩 收到服务器文本：\n" + e.data);
                }
                ws.close();
            };

            ws.onclose = () => {
                log("🔚 连接已关闭");
                cleanup();
            };

            ws.onerror = err => log("❌ WS Error: " + err.message);

            recorder.ondataavailable = ev => {
                if (stopRequested) return;                   // 结束后不再推流
                if (ws.readyState === WebSocket.OPEN && ev.data.size) {
                    ws.send(ev.data);
                    log(`▶ 发送 ${(ev.data.size / 1024).toFixed(1)} KB`);
                }
            };

            recorder.onstop = () => {
                if (ws.readyState === WebSocket.OPEN) {
                    stopRequested = true;
                    ws.send("DONE");                           // 告知后端录音完毕
                    log("🚩 已发送 DONE");
                }
            };
        };

        // -------- 停止录音 --------
        $stop.onclick = () => {
            if (recorder && recorder.state === "recording") {
                recorder.stop();
                $stop.disabled = true;
                log("⏹️ 用户停止录音");
            }
        };

        // -------- 显示 Quiz --------
        function showQuiz(item){
            const div = document.createElement("div");
            div.className = "quiz";
            div.innerHTML = `
      <b>${item.quiz.question}</b>
      ${item.quiz.options.map((op,i)=>`${"ABCD"[i]}. ${op}`).join("<br>")}
      <br><i>答案：${item.quiz.answer}</i>`;
            $log.appendChild(div);
            $log.scrollTop = $log.scrollHeight;
        }

        // -------- 清理状态 --------
        function cleanup(){
            clearInterval(timerId);
            $timer.textContent = "";
            $start.disabled = false;
            $stop.disabled  = true;
        }
    })();
</script>
</body>
</html>
