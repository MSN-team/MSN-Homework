<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®æ—¶å½•éŸ³ Â· PopQuiz Demo</title>
    <style>
        body  { font-family:sans-serif; padding:2rem; }
        button{ margin-right:1rem; padding:.6rem 1.4rem; font-size:1rem; }
        #log  { white-space:pre-wrap; border:1px solid #ccc; height:16rem;
            padding:1rem; margin-top:1rem; overflow-y:auto; font-size:.95rem; }
        .quiz{ margin:.8rem 0; padding:.6rem; border:1px dashed #999; }
        .quiz b{ display:block; margin-bottom:.4rem; }
    </style>
</head>
<body>
<button id="start">ğŸ™ï¸ å¼€å§‹å½•éŸ³</button>
<button id="stop"  disabled>â–  åœæ­¢å½•éŸ³</button>
<span id="timer"></span>
<div id="log"></div>

<script>
    (() => {
        const WS_URL   = "ws://127.0.0.1:8000/record-audio";
        const CHUNK_MS = 1000;          // æ¯ 1 s æ¨é€ä¸€æ¬¡

        let recorder, ws, timerId, startAt, stopRequested = false;
        const $start = document.getElementById("start");
        const $stop  = document.getElementById("stop");
        const $log   = document.getElementById("log");
        const $timer = document.getElementById("timer");

        const log = msg => { $log.textContent += msg + "\n";
            $log.scrollTop = $log.scrollHeight; };

        // -------- è®¡æ—¶å™¨ --------
        const tick = () => {
            const sec = Math.floor((Date.now() - startAt) / 1000);
            $timer.textContent = `â±ï¸ ${sec}s`;
        };

        // -------- å¼€å§‹å½•éŸ³ --------
        $start.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
            } catch (err) {
                log("âŒ æ— æ³•è®¿é—®éº¦å…‹é£ï¼š" + err.message);
                return;
            }

            $start.disabled = true; $stop.disabled = false;
            stopRequested = false;

            ws = new WebSocket(WS_URL);
            ws.binaryType = "arraybuffer";

            ws.onopen = () => {
                log("âœ… WebSocket å·²è¿æ¥");
                recorder.start(CHUNK_MS);
                startAt = Date.now();
                timerId = setInterval(tick, 1000);
                log("ğŸ¤ å¼€å§‹å½•éŸ³â€¦");
            };

            ws.onmessage = e => {
                try {
                    const data = JSON.parse(e.data);
                    if (data.status === "success") {
                        log("ğŸ“© æ”¶åˆ°æœåŠ¡å™¨ç»“æœï¼š");
                        data.quizzes.forEach(q => showQuiz(q));
                    } else {
                        log("âš ï¸ æœåŠ¡å™¨è¿”å›é”™è¯¯ï¼š" + data.detail);
                    }
                } catch {
                    log("ğŸ“© æ”¶åˆ°æœåŠ¡å™¨æ–‡æœ¬ï¼š\n" + e.data);
                }
                ws.close();
            };

            ws.onclose = () => {
                log("ğŸ”š è¿æ¥å·²å…³é—­");
                cleanup();
            };

            ws.onerror = err => log("âŒ WS Error: " + err.message);

            recorder.ondataavailable = ev => {
                if (stopRequested) return;                   // ç»“æŸåä¸å†æ¨æµ
                if (ws.readyState === WebSocket.OPEN && ev.data.size) {
                    ws.send(ev.data);
                    log(`â–¶ å‘é€ ${(ev.data.size / 1024).toFixed(1)} KB`);
                }
            };

            recorder.onstop = () => {
                if (ws.readyState === WebSocket.OPEN) {
                    stopRequested = true;
                    ws.send("DONE");                           // å‘ŠçŸ¥åç«¯å½•éŸ³å®Œæ¯•
                    log("ğŸš© å·²å‘é€ DONE");
                }
            };
        };

        // -------- åœæ­¢å½•éŸ³ --------
        $stop.onclick = () => {
            if (recorder && recorder.state === "recording") {
                recorder.stop();
                $stop.disabled = true;
                log("â¹ï¸ ç”¨æˆ·åœæ­¢å½•éŸ³");
            }
        };

        // -------- æ˜¾ç¤º Quiz --------
        function showQuiz(item){
            const div = document.createElement("div");
            div.className = "quiz";
            div.innerHTML = `
      <b>${item.quiz.question}</b>
      ${item.quiz.options.map((op,i)=>`${"ABCD"[i]}. ${op}`).join("<br>")}
      <br><i>ç­”æ¡ˆï¼š${item.quiz.answer}</i>`;
            $log.appendChild(div);
            $log.scrollTop = $log.scrollHeight;
        }

        // -------- æ¸…ç†çŠ¶æ€ --------
        function cleanup(){
            clearInterval(timerId);
            $timer.textContent = "";
            $start.disabled = false;
            $stop.disabled  = true;
        }
    })();
</script>
</body>
</html>
